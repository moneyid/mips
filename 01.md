MIP-01: Protocol Foundation
===========================

`author: moneyid` `status: draft`

---

Everything needed to resolve a MoneyID and communicate with a service. This document covers address format, URL resolution, URI scheme, transport rules, error handling, and versioning.

## MoneyID Address Format

A MoneyID is a human-readable identifier in the form `user@domain`. It looks like an email address but resolves to crypto payment endpoints.

### Format

```
<username>@<domain>
```

Examples:
- `bob@receiver.com`
- `alice@pay.example.org`
- `shop+invoices@merchant.co`

### Username Rules

- Allowed characters: `a-z0-9-_.+`
- Case-insensitive (wallets MUST normalize to lowercase before resolving)
- Maximum 64 characters (excluding domain)
- The `+` character is reserved for tags (see Tags section below)

### Resolution

Given a MoneyID `bob@receiver.com`, the wallet constructs:

```
GET https://receiver.com/.well-known/moneyid/bob
```

General form:

```
GET https://<domain>/.well-known/moneyid/<username>
```

The `.well-known/moneyid/` path differentiates MoneyID from Lightning Address (`.well-known/lnurlp/`) and other protocols.

### Tags

A MoneyID address supports tags using the `+` separator:

```
<username>+<tag>@<domain>
```

Tags allow a single user to expose multiple payment endpoints for different purposes:

| Address | Purpose |
|---------|---------|
| `bob@receiver.com` | Bob's default payment endpoint |
| `bob+donation@receiver.com` | Donations to Bob |
| `bob+invoice-2024-001@receiver.com` | A specific invoice |
| `bob+tips@receiver.com` | Tips for Bob |
| `shop+order-789@merchant.co` | A specific order |

The wallet resolves a tagged address by including the full `username+tag` in the path:

```
GET https://receiver.com/.well-known/moneyid/bob+donation
```

**Service behavior**: The service MUST route the request to the user identified by the `username` portion (before the `+`). The `tag` portion is opaque to the wallet -- the service interprets it however it chooses. Common uses:

- **Categorization**: Different currencies, amounts, or metadata per tag (e.g., `bob+donation` might only accept USDC, while `bob+freelance` accepts any stablecoin).
- **Invoicing**: A tag can reference a specific invoice or order. The service can pre-fill the amount and restrict the currencies.
- **Accounting**: Tags help the receiver distinguish incoming payments by purpose without needing separate accounts.

If the service does not recognize a tag, it SHOULD fall back to the user's default payment endpoint (equivalent to no tag). It MAY also return an error if strict tag matching is required.

The discovery response ([MIP-02](02.md)) includes a `text/tag` metadata entry when a tag is present, so wallets can display the tag context to the payer.

## URI Scheme

MoneyID defines the `moneyid:` URI scheme so wallets can unambiguously identify MoneyID links.

### Address URIs

```
moneyid:bob@receiver.com
moneyid:bob+donation@receiver.com
```

A wallet receiving a `moneyid:` URI extracts the address and resolves it per the rules above.

### URL URIs

For direct URLs (e.g., from a service that doesn't use human-readable addresses):

```
moneyid:https://service.com/api/pay/abc123
```

The wallet GETs the embedded URL and processes the JSON response.

### Usage in QR Codes

QR codes SHOULD use the `moneyid:` scheme so that scanning apps can route to the correct wallet:

```
moneyid:bob@receiver.com
```

For QR codes displayed in contexts where the `moneyid:` scheme may not be recognized (e.g., printed materials aimed at a general audience), services MAY fall back to encoding the full HTTPS resolution URL:

```
https://receiver.com/.well-known/moneyid/bob
```

Wallets detecting a `.well-known/moneyid/` path in an HTTPS URL SHOULD treat it as a MoneyID endpoint.

### Embedding in Web Pages

MoneyID addresses can be embedded as query parameters or HTML links:

```html
<a href="moneyid:bob@receiver.com">Pay Bob</a>
```

```
https://merchant.com/checkout?moneyid=bob@receiver.com
```

## URL Resolution

### Direct URLs

Beyond the `user@domain` format, MoneyID supports direct HTTPS URLs for programmatic use cases (API-generated links, NFC tags, deep links):

```
https://service.com/api/pay/abc123
```

A wallet encountering a MoneyID URL (via the `moneyid:` scheme or `.well-known/moneyid/` path detection) makes a GET request and follows the same flow as an address resolution.

### Response Format

All MoneyID endpoints return JSON.

For **initial discovery responses** (the response to resolving a MoneyID address or direct MoneyID URL), the `tag` field identifies the flow:

```json
{
  "tag": "payRequest",
  ...
}
```

Valid discovery tags:

| Tag | Flow | Defined in |
|-----|------|-----------|
| `payRequest` | Send money to the resolved identity | [MIP-02](02.md) |
| `withdrawRequest` | Receive money from the service | Reserved for future MIP |

For **follow-up endpoints** defined by a specific flow (for example, `callback` or `confirmUrl` in [MIP-02](02.md)), response fields are defined by that flow and MAY omit `tag`.

### Error Format

When a request fails, the service MUST return:

```json
{
  "status": "ERROR",
  "code": "INVALID_AMOUNT",
  "reason": "Human-readable error description"
}
```

The `code` field is OPTIONAL but RECOMMENDED. When present, it MUST be a stable machine-readable string in `SCREAMING_SNAKE_CASE`.

The `reason` field is for display to the user. Wallets MUST NOT parse it programmatically.

## Transport Rules

### HTTPS

All MoneyID endpoints MUST be served over HTTPS. Self-signed certificates are not allowed. HTTP is only acceptable for `.onion` addresses.

### CORS

Endpoints MUST set:

```
Access-Control-Allow-Origin: *
```

If `Access-Control-Allow-Methods` is set, it MUST include `GET` and `POST`.

This ensures MoneyID works in browser-based wallets and web applications.

### Content-Type

All responses MUST use:

```
Content-Type: application/json
```

### HTTP Status Codes

Clients SHOULD NOT rely on HTTP status codes to determine success or failure. The response body is authoritative. A service MAY return `200 OK` with an error body. Clients MUST parse the JSON body and check for the `status: "ERROR"` field.

## Versioning

### Response Versioning

MoneyID responses MAY include a version field:

```json
{
  "tag": "payRequest",
  "mipVersion": "1.0",
  ...
}
```

If `mipVersion` is absent, clients MUST assume `"1.0"`.

### Request Versioning

Clients MAY include their supported version as a query parameter on the initial GET:

```
GET https://receiver.com/.well-known/moneyid/bob?mipVersion=1.0
```

Services MAY use this to adjust their response format for backward compatibility. If the query parameter is absent, services MUST assume `"1.0"`.

### Version Format

Versions follow `major.minor`:
- **Major**: Breaking changes to existing fields or flows
- **Minor**: Additive changes (new optional fields)

The current version is `1.0`.

## Security Considerations

- Services MUST use HTTPS to prevent man-in-the-middle attacks on payment instructions.
- Payment instructions returned by [MIP-02](02.md) SHOULD use short expiry times to limit the window for address reuse or rate manipulation.
- Services SHOULD generate fresh payment addresses per request when possible, rather than returning a static address.
- When resolving a MoneyID address (`user@domain`), wallets MUST verify that the initial `.well-known/moneyid/` response is served by the expected `domain`. Note that URLs returned within the response (`callback`, `confirmUrl`, `balanceCheck`, etc.) MAY point to a different domain (e.g., an API subdomain or payment processor). This is expected and acceptable -- the domain verification applies only to the initial resolution step.
