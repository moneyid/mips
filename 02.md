MIP-02: Pay
============

`author: moneyid` `status: draft`

---

The complete send-money flow. This single document covers currency and chain discovery, payment requests, payment instructions, metadata, comments, payer identity, currency conversion, and success actions.

## Overview

A wallet resolves a MoneyID (per [MIP-01](01.md)), discovers what currencies and chains the receiver supports, lets the user choose an amount and currency, then gets back a payment instruction with an on-chain address to transfer to.

```
Wallet                                    Service
  |                                          |
  |  GET /.well-known/moneyid/<user>         |
  |----------------------------------------->|
  |  payRequest response (currencies, meta)  |
  |<-----------------------------------------|
  |                                          |
  |  POST callback {amount, currency, network, chainId} |
  |----------------------------------------->|
  |  paymentInstruction {address, expiry}    |
  |<-----------------------------------------|
  |                                          |
  |  On-chain transfer                       |
  |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~->|
  |                                          |
  |  POST confirmUrl {txHash} (optional)     |
  |----------------------------------------->|
  |  successAction (optional)                |
  |<-----------------------------------------|
  |                                          |
  |  GET confirmUrl (optional, poll status)  |
  |----------------------------------------->|
  |  {status: CONFIRMED, successAction}      |
  |<-----------------------------------------|
```

## Step 1: Discovery

The wallet resolves the MoneyID address or direct URL per [MIP-01](01.md) and receives a JSON response.

### Request

```http
GET https://receiver.com/.well-known/moneyid/bob?mipVersion=1.0
```

### Response

```json
{
  "tag": "payRequest",
  "callback": "https://receiver.com/api/pay/bob",
  "metadata": [
    ["text/plain", "Pay Bob"],
    ["text/long-desc", "Bob accepts stablecoin payments for freelance design work."],
    ["image/png;base64", "iVBORw0KGgo..."],
    ["text/identifier", "bob@receiver.com"]
  ],
  "currencies": [
    {
      "code": "USDT",
      "name": "Tether USD",
      "symbol": "$",
      "decimals": 6,
      "chains": [
        {
          "network": "ethereum",
          "chainId": "1",
          "tokenAddress": "0xdAC17F958D2ee523a2206206994597C13D831ec7"
        },
        {
          "network": "tron",
          "chainId": "tron-mainnet",
          "tokenAddress": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"
        },
        {
          "network": "solana",
          "chainId": "solana-mainnet",
          "tokenAddress": "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"
        }
      ],
      "minSendable": "1000000",
      "maxSendable": "1000000000000"
    },
    {
      "code": "USDC",
      "name": "USD Coin",
      "symbol": "$",
      "decimals": 6,
      "chains": [
        {
          "network": "ethereum",
          "chainId": "1",
          "tokenAddress": "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"
        },
        {
          "network": "base",
          "chainId": "8453",
          "tokenAddress": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
        },
        {
          "network": "solana",
          "chainId": "solana-mainnet",
          "tokenAddress": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
        }
      ],
      "minSendable": "1000000",
      "maxSendable": "1000000000000"
    }
  ],
  "commentAllowed": 280,
  "payerData": {
    "name": { "mandatory": false },
    "identifier": { "mandatory": false }
  }
}
```

### Tags

When the address includes a tag (e.g., `bob+freelance@receiver.com`), the service SHOULD include `text/tag` and `text/identifier` metadata entries reflecting the tag context:

```json
{
  "metadata": [
    ["text/plain", "Pay Bob for freelance work"],
    ["text/identifier", "bob+freelance@receiver.com"],
    ["text/tag", "freelance"]
  ]
}
```

See [MIP-01 Tags](01.md#tags) for full details on the tag format and service behavior.

### Field Reference

#### Top-level fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `tag` | string | Yes | Always `"payRequest"` |
| `callback` | string | Yes | URL to POST the payment request to (Step 2) |
| `metadata` | array | Yes | Array of `[type, content]` pairs describing the payment target |
| `currencies` | array | Yes | Supported currencies and chains (see below) |
| `commentAllowed` | number | No | Maximum character length for an optional payer comment. Omit or set to `0` to disallow comments. |
| `payerData` | object | No | Payer identity fields the service accepts (see Payer Data section) |
| `mipVersion` | string | No | Protocol version (e.g., `"1.0"`). Omit or default to `"1.0"`. |

#### Metadata

The `metadata` array contains `[type, content]` pairs. The first element of each pair is a MIME-like type string, the second is the content.

| Type | Required | Description |
|------|----------|-------------|
| `text/plain` | Yes | Short description displayed in the wallet when paying and in the transaction log |
| `text/long-desc` | No | Longer description, MAY contain newlines |
| `text/identifier` | No | The MoneyID address associated with this payment endpoint (e.g., `bob@receiver.com`) |
| `text/tag` | No | The tag portion of a tagged address. Present when the address was resolved with a `+tag` (e.g., `["text/tag", "donation"]`). Wallets SHOULD display this to give the payer context. |
| `image/png;base64` | No | Base64-encoded PNG thumbnail, max 512x512px, max 136536 characters |
| `image/jpeg;base64` | No | Base64-encoded JPEG thumbnail, max 512x512px, max 136536 characters |

At most one image entry (`png` or `jpeg`) SHOULD be included. The `metadata` array MUST contain at least one `text/plain` entry. Services MAY include additional custom types.

#### Currency Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `code` | string | Yes | Currency/token code (e.g., `"USDT"`, `"USDC"`, `"ETH"`) |
| `name` | string | Yes | Human-readable name |
| `symbol` | string | Yes | Display symbol (e.g., `"$"`, `"Îž"`) |
| `decimals` | number | Yes | Number of decimal places in the token's smallest unit |
| `chains` | array | Yes | Chains this currency is available on (see below) |
| `minSendable` | string | Yes | Minimum amount in the token's smallest unit |
| `maxSendable` | string | Yes | Maximum amount in the token's smallest unit |

Amounts are strings to avoid floating-point precision loss with large numbers. `minSendable` MUST be at least `"1"`. `maxSendable` MUST be greater than or equal to `minSendable`.

#### Chain Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `network` | string | Yes | Human-readable network name (e.g., `"ethereum"`, `"base"`, `"solana"`, `"tron"`) |
| `chainId` | string | Yes | Chain identifier string. For EVM in MIP-1.0, use decimal chain IDs as strings (e.g., `"1"`, `"8453"`). For non-EVM, use network-specific canonical IDs (e.g., `"solana-mainnet"`, `"tron-mainnet"`). |
| `tokenAddress` | string | No | Token contract address. Omit for native assets (e.g., ETH on Ethereum, SOL on Solana). |

#### Network Names

Services SHOULD use these canonical network names and `chainId` values for common chains:

| Network | `network` | `chainId` |
|---------|-----------|-----------|
| Ethereum Mainnet | `ethereum` | `1` |
| Polygon | `polygon` | `137` |
| Arbitrum One | `arbitrum` | `42161` |
| Base | `base` | `8453` |
| Optimism | `optimism` | `10` |
| BNB Smart Chain | `bsc` | `56` |
| Avalanche C-Chain | `avalanche` | `43114` |
| Solana | `solana` | `solana-mainnet` |
| Tron | `tron` | `tron-mainnet` |

## Step 2: Payment Request

After the user selects an amount, currency, and chain, the wallet POSTs to the `callback` URL.

### Request

```http
POST https://receiver.com/api/pay/bob
Content-Type: application/json
Idempotency-Key: 4c8f4f1e-7ec2-4a11-9f4f-4f77e0a3f8f8
```

```json
{
  "amount": "10000000",
  "currency": "USDT",
  "network": "ethereum",
  "chainId": "1",
  "tokenAddress": "0xdAC17F958D2ee523a2206206994597C13D831ec7",
  "comment": "Thanks for the design work!",
  "payerData": {
    "name": "Alice",
    "identifier": "alice@sender.com"
  }
}
```

### Field Reference

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `amount` | string | Yes | Amount in the token's smallest unit |
| `currency` | string | Yes | Currency code from the discovery response |
| `network` | string | Yes | Network name from the discovery response |
| `chainId` | string | Yes | Chain identifier from the selected chain object in discovery |
| `tokenAddress` | string | Conditional | Token contract address from the selected chain object. REQUIRED when the selected chain object includes `tokenAddress`; omitted for native assets. |
| `comment` | string | No | Payer comment, max length per `commentAllowed` |
| `payerData` | object | No | Payer identity (see Payer Data section) |

The `amount` MUST be between `minSendable` and `maxSendable` for the chosen currency. The tuple (`currency`, `network`, `chainId`, `tokenAddress` when applicable) MUST match the selected currency/chain combination from the discovery response.

Wallets SHOULD send an `Idempotency-Key` header for Step 2 POST requests so retries caused by network failures do not create duplicate payment instructions.

## Step 3: Payment Instruction

The service responds with everything the wallet needs to execute the on-chain transfer.

### Response

```json
{
  "paymentInstruction": {
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f2bD18",
    "network": "ethereum",
    "chainId": "1",
    "tokenAddress": "0xdAC17F958D2ee523a2206206994597C13D831ec7",
    "amount": "10000000",
    "expiry": 1709312400
  },
  "confirmUrl": "https://receiver.com/api/pay/bob/confirm/txn_a1b2c3",
  "successAction": {
    "tag": "message",
    "message": "Payment received! Receipt: #INV-2024-001"
  }
}
```

### Payment Instruction Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `address` | string | Yes | Destination address for the transfer |
| `network` | string | Yes | Network name |
| `chainId` | string | Yes | Canonical chain identifier |
| `tokenAddress` | string | No | Token contract address. Omit for native asset transfers. |
| `amount` | string | Yes | Exact amount to transfer in the token's smallest unit |
| `expiry` | number | Yes | Unix timestamp (seconds) after which this instruction is no longer valid |
| `callData` | string | No | Hex-encoded calldata for smart contract interactions, if the payment requires more than a simple transfer |
| `memo` | string | No | Chain-specific memo/tag (e.g., for Stellar, Cosmos, or exchange deposits) |

### Additional Response Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `confirmUrl` | string | No | Dedicated URL for transaction confirmation and status polling. POST the txHash after broadcasting (Step 4), GET to poll payment status (Step 5). If absent, the wallet skips confirmation and status polling. |
| `successAction` | object | No | Action to display after payment (see Success Actions) |
| `conversion` | object | No | Currency conversion details (see Currency Conversion) |
| `mipVersion` | string | No | Protocol version. If absent, assume `"1.0"`. |

The wallet MUST verify:
- `network` and `chainId` match the requested chain
- `amount` matches the requested amount
- `expiry` is in the future
- If `tokenAddress` is present, it matches the selected token from discovery
- If the selected discovery chain has no `tokenAddress` (native asset), the instruction MUST omit `tokenAddress`

The wallet then executes the on-chain transfer using the provided `address`, `amount`, and `tokenAddress`.

### Disposable vs Reusable

The service controls whether a payment instruction is single-use or reusable:
- **Disposable**: Generate a unique address per request with a short `expiry`. This is the recommended default for privacy and accounting.
- **Reusable**: Return the same address with a longer `expiry`. Suitable for donation endpoints or static QR codes.

## Point-of-Sale Payments

MoneyID is designed to work on payment terminals. A merchant terminal displays a QR code, the customer scans it, and the payment completes with no manual entry.

### Fixed-Amount Payments (Closed Amount)

When the merchant knows the exact amount (a checkout total, an invoice), the service sets `minSendable` equal to `maxSendable` for each currency. The wallet sees they are equal and SHOULD skip the amount selection step -- the amount is already decided.

Example: a coffee shop terminal generating a QR for a $5.00 order.

```
moneyid:shop+order-42@merchant.co
```

The discovery response:

```json
{
  "tag": "payRequest",
  "callback": "https://merchant.co/api/pay/shop",
  "metadata": [
    ["text/plain", "CoffeeShop - Order #42"],
    ["text/identifier", "shop+order-42@merchant.co"],
    ["text/tag", "order-42"]
  ],
  "currencies": [
    {
      "code": "USDC",
      "name": "USD Coin",
      "symbol": "$",
      "decimals": 6,
      "chains": [
        { "network": "base", "chainId": "8453", "tokenAddress": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913" },
        { "network": "solana", "chainId": "solana-mainnet", "tokenAddress": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v" }
      ],
      "minSendable": "5000000",
      "maxSendable": "5000000"
    },
    {
      "code": "USDT",
      "name": "Tether USD",
      "symbol": "$",
      "decimals": 6,
      "chains": [
        { "network": "tron", "chainId": "tron-mainnet", "tokenAddress": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t" }
      ],
      "minSendable": "5000000",
      "maxSendable": "5000000"
    }
  ]
}
```

The wallet displays: "Pay $5.00 to CoffeeShop - Order #42". The customer picks a currency and chain, taps confirm, done. No amount to type, no address to copy, no chain to guess.

### Open-Amount Payments

When the amount is not known upfront (tips, donations, custom payments), the service sets `minSendable` and `maxSendable` to different values. The wallet presents an amount input within that range. This is the default behavior described in Step 1-3 above.

### Terminal Confirmation

For POS use cases, the terminal needs to know when payment is complete so it can display a confirmation, print a receipt, or release a product. The `confirmUrl` in Step 4 is what makes this possible.

When the wallet POSTs the `txHash` to the `confirmUrl`, the service receives instant notification of the payment. The service then signals the terminal (through its own internal mechanism) that the order is paid.

**Services SHOULD always include a `confirmUrl` for POS and terminal use cases.** Without it, the service must poll the blockchain to detect the payment, which adds latency -- unacceptable when a customer is standing at a counter.

The flow at a terminal:

```
Terminal                  Service                   Wallet
  |                         |                         |
  |  Create order           |                         |
  |------------------------>|                         |
  |  QR code                |                         |
  |<------------------------|                         |
  |                         |                         |
  |  [Customer scans QR]    |   GET /.well-known/...  |
  |                         |<------------------------|
  |                         |   payRequest response   |
  |                         |------------------------>|
  |                         |                         |
  |                         |   POST callback         |
  |                         |<------------------------|
  |                         |   paymentInstruction    |
  |                         |------------------------>|
  |                         |                         |
  |                         |   [On-chain transfer]   |
  |                         |                         |
  |                         |   POST confirmUrl       |
  |                         |<------------------------|
  |                         |   {txHash}              |
  |                         |                         |
  |                         |   GET confirmUrl        |
  |                         |<------------------------|
  |                         |   {status: PENDING}     |
  |                         |------------------------>|
  |                         |          ...            |
  |                         |   GET confirmUrl        |
  |                         |<------------------------|
  |  Payment confirmed!     |   {status: CONFIRMED}   |
  |<------------------------|------------------------>|
  |  [Print receipt]        |                         |
```

## Step 4: Transaction Confirmation (Optional)

After broadcasting the transaction, the wallet MAY notify the service for faster confirmation. This is only available when the Step 3 response includes a `confirmUrl`.

The `confirmUrl` is a **separate, dedicated endpoint** -- distinct from the `callback` used in Step 2. The service generates a unique `confirmUrl` per payment instruction, which also lets it correlate the transaction hash to the specific payment without ambiguity.

### Request

```http
POST https://receiver.com/api/pay/bob/confirm/txn_a1b2c3
Content-Type: application/json
```

```json
{
  "txHash": "0xabc123def456...",
  "network": "ethereum",
  "chainId": "1"
}
```

The service SHOULD NOT trust the txHash alone -- it MUST verify the transaction on-chain before considering the payment complete.

The `confirmUrl` is unique per payment instruction and therefore acts as the idempotency scope for Step 4/5. Services MUST make `POST confirmUrl` idempotent: repeating the same `txHash` MUST NOT create duplicate credits or duplicate side effects. Because the URL already scopes idempotency, wallets do not need to send an additional `Idempotency-Key` header on `confirmUrl`.

### Response

The service MAY return a `successAction` if one wasn't provided in Step 3, or an updated one.

For successful responses, `status` is optional and, if present, MUST be `"OK"`. Error responses use the [MIP-01 error format](01.md#error-format) with `status: "ERROR"`.

Example:

```json
{
  "status": "OK",
  "successAction": {
    "tag": "url",
    "description": "View your receipt",
    "url": "https://receiver.com/receipts/INV-2024-001"
  }
}
```

## Step 5: Payment Status (Optional)

After broadcasting, the wallet MAY poll the `confirmUrl` with a GET request to check whether the service has seen and verified the payment. This is useful when:

- The wallet app was closed or crashed after broadcasting and needs to recover state.
- The wallet wants to show a spinner until the service confirms.
- The wallet needs to retrieve the `successAction` after the fact.

### Request

```http
GET https://receiver.com/api/pay/bob/confirm/txn_a1b2c3
```

### Response

```json
{
  "status": "CONFIRMED",
  "successAction": {
    "tag": "message",
    "message": "Payment received! Thank you."
  }
}
```

### Status Values

| Status | Meaning |
|--------|---------|
| `PENDING` | Service has not yet seen or verified the payment on-chain |
| `CONFIRMED` | Service has verified the payment and credited the receiver |
| `EXPIRED` | The payment instruction expired before payment was detected |
| `ERROR` | Something went wrong; includes a `reason` field |

The `successAction` field is only present when `status` is `CONFIRMED`.

Wallets SHOULD use exponential backoff when polling (e.g., 2s, 4s, 8s, 16s, up to 60s).

**Note:** The `confirmUrl` serves dual purpose -- POST to notify (Step 4) and GET to poll (Step 5). The wallet typically POSTs the txHash first, then polls with GET until the status transitions to `CONFIRMED` or `EXPIRED`.

## Success Actions

The `successAction` field tells the wallet what to show the user after payment. It is optional and can appear in the Step 3 response, the Step 4 response, the Step 5 response, or any combination. The latest response takes precedence.

### Types

#### `message` -- Display text

```json
{
  "tag": "message",
  "message": "Payment received! Thank you."
}
```

The wallet displays the message to the user. Maximum 144 characters.

#### `url` -- Redirect

```json
{
  "tag": "url",
  "description": "View your receipt",
  "url": "https://receiver.com/receipts/INV-2024-001"
}
```

The wallet shows the description and offers to open the URL. The URL MUST be HTTPS.

## Payer Data

The `payerData` field enables optional identity exchange. In the discovery response, the service declares which payer fields it accepts:

```json
{
  "payerData": {
    "name": { "mandatory": false },
    "identifier": { "mandatory": false },
    "email": { "mandatory": false }
  }
}
```

Each key is a field name. `mandatory: true` means the wallet MUST provide it or the payment will be rejected. `mandatory: false` means it is optional.

In the payment request (Step 2), the wallet includes whichever fields the user consents to share:

```json
{
  "payerData": {
    "name": "Alice",
    "identifier": "alice@sender.com"
  }
}
```

### Standard Payer Data Fields

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Payer's display name |
| `identifier` | string | Payer's MoneyID address or other identifier |
| `email` | string | Payer's email address |

Services and wallets MAY negotiate additional fields beyond these.

## Currency Conversion

When the service converts between currencies on behalf of the receiver, the Step 3 response includes a `conversion` object. This is purely informational for the wallet to display to the user.

### Example: Payer sends USDC, receiver gets EURC

The payer sends 10 USDC. The service converts to EURC (EUR stablecoin, 6 decimals) for the receiver.

```json
{
  "paymentInstruction": {
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f2bD18",
    "network": "ethereum",
    "chainId": "1",
    "tokenAddress": "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
    "amount": "10000000",
    "expiry": 1709312400
  },
  "conversion": {
    "from": { "code": "USDC", "amount": "10000000", "decimals": 6 },
    "to": { "code": "EURC", "amount": "9150000", "decimals": 6 },
    "fee": { "amount": "50000", "currency": "USDC", "decimals": 6 }
  }
}
```

In this example: the payer transfers 10.000000 USDC. After a 0.050000 USDC fee, the receiver gets 9.150000 EURC.

### Conversion Fields

| Field | Type | Description |
|-------|------|-------------|
| `from` | object | What the payer sends: `code`, `amount` (smallest unit), `decimals` |
| `to` | object | What the receiver gets: `code`, `amount` (smallest unit), `decimals` |
| `fee` | object | Fee charged: `amount` (smallest unit), `currency` code, `decimals` |

Each side includes its own `decimals` so the wallet can display amounts correctly without needing to look up the target currency. The `amount` fields are strings in the smallest unit of their respective currency.

The conversion is implicitly valid until `paymentInstruction.expiry`. Services SHOULD use short expiry times when conversion is involved to minimize exchange rate risk.

## Idempotency and Retry Semantics

### Step 2 (`POST callback`)

- Wallets SHOULD send `Idempotency-Key` on every Step 2 POST.
- Services SHOULD treat (`callback` URL, `Idempotency-Key`) as an idempotency key for the request.
- If the same key is replayed with the same request payload, the service SHOULD return the same semantic outcome (or an equivalent successful response).
- If the same key is replayed with a different payload, the service MUST reject it with an error (for example, `IDEMPOTENCY_KEY_REUSED`).

### Step 4 (`POST confirmUrl`)

- Services MUST treat `confirmUrl` as idempotent by design.
- Repeated POSTs with the same `txHash` to the same `confirmUrl` MUST be safe and MUST NOT double-credit.
- If payment is already confirmed for that `confirmUrl`, the service SHOULD return success or a deterministic error without changing state.

### Step 5 (`GET confirmUrl`)

- GET is safe to retry and has no side effects.
- Wallets SHOULD use exponential backoff when polling (e.g., 2s, 4s, 8s, 16s, up to 60s).
- Wallets SHOULD stop polling when status is terminal (`CONFIRMED`, `EXPIRED`, or `ERROR`).

## Error Handling

At any step, the service MAY return an error:

```json
{
  "status": "ERROR",
  "code": "INVALID_AMOUNT",
  "reason": "Amount exceeds maximum allowed"
}
```

`code` is OPTIONAL but RECOMMENDED and MUST be a stable machine-readable string in `SCREAMING_SNAKE_CASE` when present. `reason` is human-readable.

### Standard Error Codes

| Code | Meaning |
|------|---------|
| `INVALID_REQUEST` | Malformed JSON, missing required fields, or invalid field types |
| `INVALID_AMOUNT` | Amount is outside the allowed range |
| `UNSUPPORTED_CURRENCY` | Requested `currency` is not supported |
| `UNSUPPORTED_CHAIN` | Requested (`network`, `chainId`) is not supported |
| `UNSUPPORTED_ASSET` | Requested `tokenAddress` (or native/non-native mode) is not supported |
| `EXPIRED_INSTRUCTION` | Payment instruction or `confirmUrl` has expired |
| `PAYMENT_NOT_FOUND` | No payment instruction found for this confirmation endpoint |
| `ALREADY_CONFIRMED` | Payment was already confirmed for this instruction |
| `IDEMPOTENCY_KEY_REUSED` | Same idempotency key reused with a different payload |
| `INTERNAL_ERROR` | Generic service-side failure |

The wallet MUST display the `reason` to the user and abort the flow.

## Conformance Checklist

### Wallet

- MUST validate Step 3 instruction fields against selected Step 1 chain/token and requested amount.
- MUST reject instructions with expired `expiry`.
- SHOULD send `Idempotency-Key` on Step 2 POST requests.
- SHOULD retry Step 2 on network failures using the same `Idempotency-Key`.
- SHOULD POST `txHash` to `confirmUrl` when available, then poll with GET until terminal status.
- MUST treat `ERROR` responses as terminal for the current attempt and display `reason`.

### Service

- MUST enforce tuple matching between Step 2 request and Step 1 advertised options.
- SHOULD issue short-lived payment instructions and unique `confirmUrl` values.
- MUST make `POST confirmUrl` idempotent and MUST NOT double-credit on duplicate notifications.
- SHOULD verify `txHash` on-chain before setting status to `CONFIRMED`.
- SHOULD expose stable `code` values in errors for machine handling.
- MUST use HTTPS and JSON response rules defined in [MIP-01](01.md).

## Security Considerations

- Services SHOULD generate a unique `address` for each payment request. Reusing addresses reduces privacy and complicates accounting.
- `expiry` SHOULD be short (5-15 minutes) to prevent address reuse and stale exchange rates.
- Wallets MUST verify the `tokenAddress` matches the expected token to prevent token spoofing attacks.
- The `callData` field enables powerful smart contract interactions but wallets SHOULD warn users when `callData` is present, as it executes arbitrary contract calls.
- Services MUST NOT require `payerData` fields unless strictly necessary. Excessive identity collection is a privacy concern.
- The `confirmUrl` is unique per payment instruction. Services SHOULD expire it along with the payment instruction to prevent replay.
